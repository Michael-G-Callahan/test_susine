---
title: "SuSiNE Paper Draft Exhibits"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
editor_options:
  markdown:
    wrap: 72
---

# Section 1: Setup

```{r setup, message=FALSE, warning=FALSE}
here::i_am("vignettes/visualize_results_workbook_paper_exhibits.Rmd")
library(here)
library(devtools)
devtools::load_all(".")

library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(arrow)
```

## 1.1 User Options

```{r user-options}
# Save plots to files instead of displaying in workbook?
# Set to TRUE when running on HPC or when you want PNG outputs
save_plots_to_file <- TRUE

# Show plots in the RStudio "Plots" pane while running interactively (not during render)
show_in_rstudio_plots <- TRUE

# Configure knitr devices: during render use png, during interactive use RStudioGD
if (isTRUE(getOption("knitr.in.progress"))) {
  knitr::opts_chunk$set(fig.ext = "png")
} else if (show_in_rstudio_plots && interactive()) {
  knitr::opts_chunk$set(fig.show = "hide", dev = "RStudioGD", fig.ext = "png")
} else {
  knitr::opts_chunk$set(fig.ext = "png")
}

# Best-effort helper to send plots to the Plots pane
maybe_show_plot <- function(p) {
  if (show_in_rstudio_plots && interactive()) {
    try(print(p), silent = TRUE)
  }
}

# Helper function to save or display a plot
save_or_show <- function(p, filename, width = 12, height = 8, dpi = 300, subdir = "power_fdr") {
  maybe_show_plot(p)
  if (save_plots_to_file) {
    filepath <- file.path(plot_dirs[[subdir]], filename)
    tryCatch(
      {
        ggsave(filepath, p, width = width, height = height, dpi = dpi, bg = "white")
        cat("Saved:", filename, "\n")
      },
      error = function(e) {
        cat("Error saving plot:", filename, "-", conditionMessage(e), "\n")
      }
    )
  } else {
    tryCatch(
      print(p),
      error = function(e) {
        cat("Cannot display plot (no X11 display available), but save_plots_to_file is FALSE\n")
        cat("Set save_plots_to_file = TRUE to save plots to disk instead\n")
      }
    )
  }
}
```

## 1.2 Job Configuration

```{r job-config}
job_name <- "prior_default_testing_more_annotation_scales"
parent_job_id <- "47336613"
output_root <- here("output")

# Resolve paths
paths <- test_susine::resolve_job_paths(
  job_name = job_name,
  parent_job_id = parent_job_id,
  output_root = output_root
)
```

## 1.3 Plot Directories

```{r create-plot-dirs}
plot_base_dir <- file.path(paths$aggregated_dir, "plots_paper")
plot_dirs <- list(
  power_fdr = file.path(plot_base_dir, "power_fdr"),
  auprc_simple = file.path(plot_base_dir, "auprc_simple"),
  auprc_new = file.path(plot_base_dir, "auprc_new")
)

for (d in plot_dirs) {
  dir.create(d, showWarnings = FALSE, recursive = TRUE)
}
cat("Plot directories created under:", plot_base_dir, "\n")
```

## 1.4 Use Case Filter

```{r use-case-filter}
# Use cases to include in plots (edit as needed)
use_case_filter <- c("a_i", "b_i", "b_ii")

# Get labels from catalog (will work even if filter changes)
use_case_labels <- test_susine::get_use_case_labels(use_case_filter)
print(use_case_labels)
```

## 1.5 Load Data

```{r load-data, message=FALSE}
# Confusion matrix (detailed)
confusion_detailed_path <- file.path(paths$aggregated_dir, "confusion_matrix_detailed.csv")
if (!file.exists(confusion_detailed_path)) {
  stop("Confusion matrix not found. Run collect_results_workbook.Rmd first.")
}
confusion_detailed <- readr::read_csv(confusion_detailed_path, show_col_types = FALSE)

cat("Loaded confusion matrix:", nrow(confusion_detailed), "rows\n")
```

## 1.6 Shared Palettes and Helpers

```{r palettes}
confusion_base <- confusion_detailed %>%
  dplyr::filter(use_case_id %in% use_case_filter)

# sigma_0_2_scalar values to exclude from colored plots
sigma_exclude <- c("1/L", "2/L")

# Combined palette for use_case_id + sigma/gamma splits (used for annotation_r2 plot)
combined_palette <- c(
  # a_i (SuSiE) - blues (darker = smaller sigma)
  "a_i - 0.05"  = "#08306b",
  "a_i - 0.1"   = "#2171b5",
  "a_i - 0.2"   = "#4292c6",
  "a_i - 0.4"   = "#6baed6",
  # b_i (SuSiE + functional sigma) - greens (split by gamma)
  "b_i - 0.4"   = "#238b45",
  "b_i - 0.8"   = "#74c476",
  # b_ii (SuSiNE) - oranges/reds (darker = smaller sigma)
  "b_ii - 0.05" = "#7f2704",
  "b_ii - 0.1"  = "#d94801",
  "b_ii - 0.2"  = "#f16913",
  "b_ii - 0.4"  = "#fd8d3c"
)

combined_labels <- c(
  "a_i - 0.05"  = "SuSiE - sigma=0.05",
  "a_i - 0.1"   = "SuSiE - sigma=0.1",
  "a_i - 0.2"   = "SuSiE - sigma=0.2",
  "a_i - 0.4"   = "SuSiE - sigma=0.4",
  "b_i - 0.4"   = "SuSiE+FS - gamma=0.4",
  "b_i - 0.8"   = "SuSiE+FS - gamma=0.8",
  "b_ii - 0.05" = "SuSiNE - sigma=0.05",
  "b_ii - 0.1"  = "SuSiNE - sigma=0.1",
  "b_ii - 0.2"  = "SuSiNE - sigma=0.2",
  "b_ii - 0.4"  = "SuSiNE - sigma=0.4"
)

# Palette for collapsed plots (use_case only)
use_case_palette <- c(
  "a_i" = "#08306b",
  "b_i" = "#238b45",
  "b_ii" = "#7f2704"
)

# Helper to add combined color column to data
# Filters out excluded sigma levels and creates color key:
#  - For b_i: use_case_id - gamma_shrink
#  - For others: use_case_id - sigma_0_2_scalar
add_combined_color <- function(df) {
  df %>%
    dplyr::filter(!sigma_0_2_scalar %in% sigma_exclude) %>%
    dplyr::mutate(
      use_sigma = dplyr::if_else(
        use_case_id == "b_i",
        paste(use_case_id, "-", gamma_shrink),
        paste(use_case_id, "-", sigma_0_2_scalar)
      )
    )
}
```

---

# Section 2: Power vs FDR (Paper Focused)

Collapse lines to one per use_case_id and zoom to the 0.05-0.95 PIP
threshold range.

```{r power-fdr-prep}
pip_zoom_range <- c(0.05, 0.95)
# Helper to trim curves after they are computed, so cumulative TP/FP stay monotone
filter_pip_range <- function(curves) {
  curves %>%
    dplyr::filter(
      pip_threshold >= pip_zoom_range[1],
      pip_threshold <= pip_zoom_range[2]
    )
}

# Helper to set y-axis limits to observed power range (with small padding)
power_limits <- function(curves, pad = 0.02) {
  if (nrow(curves) == 0 || all(is.na(curves$power))) return(c(0, 1))
  y_min <- max(0, min(curves$power, na.rm = TRUE) - pad)
  y_max <- min(1, max(curves$power, na.rm = TRUE) + pad)
  c(y_min, y_max)
}
```

## 2.1 Power vs FDR - Data Prep (All / Low / High p*)

```{r power-fdr-data}
curves_all <- test_susine::compute_power_fdr_curves(
  confusion_base,
  group_vars = "use_case_id"
) %>%
  filter_pip_range()

confusion_low <- confusion_base %>% dplyr::filter(p_star %in% c(1, 2, 3, 4))
curves_low <- test_susine::compute_power_fdr_curves(
  confusion_low,
  group_vars = "use_case_id"
) %>%
  filter_pip_range()

confusion_high <- confusion_base %>% dplyr::filter(p_star %in% c(5, 10, 20))
curves_high <- test_susine::compute_power_fdr_curves(
  confusion_high,
  group_vars = "use_case_id"
) %>%
  filter_pip_range()
```

## 2.2 Power vs FDR - Faceted (All / p* 1-4 / p* 5,10,20)

```{r power-fdr-faceted, fig.width=8, fig.height=12}
# Build a combined data frame with facet labels
curves_facets <- list(
  "All p*" = curves_all,
  "p* 1-4" = curves_low,
  "p* 5,10,20" = curves_high
)

curves_facets <- purrr::imap(curves_facets, ~ dplyr::mutate(.x, facet_label = .y)) %>%
  dplyr::bind_rows() %>%
  dplyr::filter(!is.na(facet_label)) %>%
  dplyr::mutate(
    facet_label = factor(facet_label, levels = c("All p*", "p* 1-4", "p* 5,10,20"))
  )

if (nrow(curves_facets) > 0) {
  p <- ggplot2::ggplot(
    curves_facets,
    ggplot2::aes(x = fdr, y = power, color = use_case_id, group = use_case_id)
  ) +
    ggplot2::geom_line(linewidth = 1.0) +
    ggplot2::geom_point(size = 3, alpha = 0.7) +
    ggplot2::facet_wrap(~facet_label, ncol = 1, scales = "free_y") +
    ggplot2::scale_color_manual(
      values = use_case_palette,
      labels = use_case_labels,
      name = "Use case"
    ) +
    ggplot2::labs(
      title = "Power vs FDR (faceted by p* group)",
      x = "False discovery rate (1 - precision)",
      y = "Power (recall)"
    ) +
    ggplot2::guides(
      color = ggplot2::guide_legend(
        title.position = "top",
        title.hjust = 0.5,
        ncol = 1,
        byrow = TRUE
      )
    ) +
    ggplot2::theme_minimal(base_size = 14) +
    ggplot2::theme(
      legend.position = "bottom",
      legend.box = "vertical",
      legend.justification = "center",
      legend.title = ggplot2::element_text(size = 16, face = "bold"),
      legend.text = ggplot2::element_text(size = 14),
      legend.box.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10),
      legend.key.width = ggplot2::unit(1.5, "lines"),
      strip.text.x = ggplot2::element_text(size = 16, face = "bold"),
      axis.title.x = ggplot2::element_text(size = 18, margin = ggplot2::margin(t = 10)),
      axis.title.y = ggplot2::element_text(size = 18),
      axis.text = ggplot2::element_text(size = 14),
      plot.title = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5),
      plot.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10)
    ) +
    ggplot2::coord_cartesian(xlim = c(0, 1))

  save_or_show(p, "power_fdr_faceted.png", width = 8, height = 12, subdir = "power_fdr")
} else {
  message("No data available for faceted Power/FDR plot")
}
```

## 2.3 Power vs FDR - Filtered One-Off (user-controlled)

```{r power-fdr-filtered, fig.width=10, fig.height=7}
# User-editable filters (NA always included in filtering)
y_noise_filter <- c(0.6)
annotation_r2_filter <- c(0.4, NA)
inflate_match_filter <- c(1, NA)
sigma_0_2_scalar_filter <- c(0.2, NA)
gamma_shrink_filter <- c(NA, 0.8)
pstar_filter <- c(5)
# Total SNPs per dataset (used for overall annotation R^2 including noncausals)
p_total <- 1000

include_with_na <- function(x, allowed) {
  is.na(x) | x %in% allowed
}

confusion_filtered <- confusion_base %>%
  dplyr::filter(
    include_with_na(y_noise, y_noise_filter),
    include_with_na(annotation_r2, annotation_r2_filter),
    include_with_na(inflate_match, inflate_match_filter),
    include_with_na(sigma_0_2_scalar, sigma_0_2_scalar_filter),
    include_with_na(gamma_shrink, gamma_shrink_filter),
    include_with_na(p_star, pstar_filter)
  )

if (nrow(confusion_filtered) > 0) {
  curves_filtered <- test_susine::compute_power_fdr_curves(
    confusion_filtered,
    group_vars = "use_case_id"
  ) %>%
    filter_pip_range()

  if (nrow(curves_filtered) > 0) {
    line_meta <- confusion_filtered %>%
      dplyr::group_by(use_case_id) %>%
      dplyr::summarise(
        n_runs = {
          nr <- n_runs
          if (all(is.na(nr))) NA_real_ else suppressWarnings(max(nr, na.rm = TRUE))
        },
        theoretical_prior_r2_vals = list(sort(unique(annotation_r2[!is.na(annotation_r2)]))),
        .groups = "drop"
      ) %>%
      dplyr::mutate(
        theoretical_prior_r2_label = purrr::map_chr(
          theoretical_prior_r2_vals,
          ~ if (length(.x) == 0) "NA" else paste(.x, collapse = ", ")
        ),
        n_runs_label = dplyr::if_else(is.na(n_runs) | is.infinite(n_runs), "NA", as.character(n_runs)),
        label = paste0(
          use_case_labels[use_case_id],
          " (runs=", n_runs_label,
          "; theoretical prior R^2=", theoretical_prior_r2_label,
          ")"
        )
      )

    if (nrow(line_meta) > 0) {
      cat("Line metadata (runs and theoretical causal annotation R^2 targets):\n")
      print(line_meta %>% dplyr::select(use_case_id, label, n_runs, theoretical_prior_r2_label))
    }

    # Theoretical overall prior annotation R^2 including noncausal SNPs:
    # Causal mu0 variance = causal_var / annotation_r2 (from noise construction)
    # Noncausal mu0 variance = causal_var * ((1 - annotation_r2) / annotation_r2 + inflate_match)
    # overall_r2 = pi / (pi / annotation_r2 + (1 - pi) * ((1 - annotation_r2) / annotation_r2 + inflate_match))
    # where pi = p_star / p_total
    ann_vals <- sort(unique(confusion_filtered$annotation_r2[!is.na(confusion_filtered$annotation_r2)]))
    inflate_vals <- sort(unique(confusion_filtered$inflate_match[!is.na(confusion_filtered$inflate_match)]))
    pstar_vals <- sort(unique(confusion_filtered$p_star[!is.na(confusion_filtered$p_star)]))

    if (length(ann_vals) == 1 && length(inflate_vals) == 1 && length(pstar_vals) == 1 && p_total > 0) {
      pi <- pstar_vals / p_total
      overall_r2 <- pi / (pi / ann_vals + (1 - pi) * ((1 - ann_vals) / ann_vals + inflate_vals))
      cat(sprintf("Theoretical overall prior annotation R^2 (including noncausal SNPs) approx %.6f\n", overall_r2))
    } else {
      cat("Cannot compute single overall prior annotation R^2 (multiple/NA annotation_r2, inflate_match, or p* values present).\n")
    }

    label_lookup <- rlang::set_names(line_meta$label, line_meta$use_case_id)

    # Compare methods at target FDR and matched power
    target_fdr <- 0.5
    power_at_target <- curves_filtered %>%
      dplyr::group_by(use_case_id) %>%
      dplyr::summarise(
        power = {
          df <- dplyr::arrange(dplyr::distinct(cur_data_all(), fdr, power), fdr)
          stats::approx(df$fdr, df$power, xout = target_fdr, ties = "ordered", rule = 2)$y
        },
        .groups = "drop"
      )

    if (nrow(power_at_target) == nrow(line_meta) && all(is.finite(power_at_target$power))) {
      best <- power_at_target %>%
        dplyr::arrange(dplyr::desc(power)) %>%
        dplyr::mutate(rank = dplyr::row_number())
      best_power <- best$power[1]

      fdr_at_best_power <- curves_filtered %>%
        dplyr::group_by(use_case_id) %>%
        dplyr::summarise(
          fdr_at_power = {
            df <- dplyr::arrange(dplyr::distinct(cur_data_all(), power, fdr), power)
            stats::approx(df$power, df$fdr, xout = best_power, ties = "ordered", rule = 2)$y
          },
          .groups = "drop"
        )

      ranking <- best %>%
        dplyr::left_join(line_meta, by = "use_case_id") %>%
        dplyr::left_join(fdr_at_best_power, by = "use_case_id")

      cat(sprintf("The best method at FDR = %.2f is: %s, with power of: %.4f\n",
                  target_fdr,
                  ranking$label[ranking$rank == 1],
                  best_power))

      if (nrow(ranking) >= 2) {
        cat(sprintf("At power %.4f the FDR of the second best method, %s, is %.4f\n",
                    best_power,
                    ranking$label[ranking$rank == 2],
                    ranking$fdr_at_power[ranking$rank == 2]))
      }
      if (nrow(ranking) >= 3) {
        cat(sprintf("At power %.4f the FDR of the third best method, %s, is %.4f\n",
                    best_power,
                    ranking$label[ranking$rank == 3],
                    ranking$fdr_at_power[ranking$rank == 3]))
      }

      if (length(pstar_vals) == 1) {
        for (i in seq_len(nrow(ranking))) {
          tp <- best_power * pstar_vals
          fp <- ranking$fdr_at_power[i] / (1 - ranking$fdr_at_power[i]) * tp
          cat(sprintf(
            "At p* = %s, and n_runs = %s per line, we would expect that using %s would have resulted in ~%.2f causal SNPs selected and ~%.2f noncausal SNPs selected.\n",
            pstar_vals,
            ranking$n_runs[i],
            ranking$label[i],
            tp,
            fp
          ))
        }
      }
    }

    p <- ggplot2::ggplot(
      curves_filtered,
      ggplot2::aes(x = fdr, y = power, color = use_case_id, group = use_case_id)
    ) +
      ggplot2::geom_line(linewidth = 1.0) +
      ggplot2::geom_point(size = 3, alpha = 0.7) +
      ggplot2::scale_color_manual(
        values = use_case_palette,
        labels = label_lookup,
        breaks = names(label_lookup),
        name = "Use case"
      ) +
      ggplot2::scale_x_continuous(
        breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2)
      ) +
      ggplot2::labs(
        title = "Power vs FDR (filtered one-off)",
        x = "False discovery rate (1 - precision)",
        y = "Power (recall)"
      ) +
      ggplot2::guides(
        color = ggplot2::guide_legend(
          title.position = "top",
          title.hjust = 0.5,
          ncol = 1
        )
      ) +
      ggplot2::theme_minimal(base_size = 14) +
      ggplot2::theme(
        legend.position = "bottom",
        legend.box = "vertical",
        legend.title = ggplot2::element_text(size = 16, face = "bold"),
        legend.text = ggplot2::element_text(size = 14),
        strip.text.x = ggplot2::element_text(size = 16, face = "bold"),
        axis.title.x = ggplot2::element_text(size = 18, margin = ggplot2::margin(t = 10)),
        axis.title.y = ggplot2::element_text(size = 18),
        axis.text = ggplot2::element_text(size = 14),
        plot.title = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5),
        plot.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10)
      ) +
      ggplot2::coord_cartesian(xlim = c(0, 1), ylim = power_limits(curves_filtered))

    save_or_show(p, "power_fdr_filtered_oneoff.png", width = 10, height = 7, subdir = "power_fdr")
  } else {
    message("No power/FDR curves after applying filters")
  }
} else {
  message("No data after applying filters for one-off Power/FDR plot")
}
```

---

# Section 3: AUPRC Simple Exhibits

## 3.1 AUPRC by Inflation Match and p* (faceted, collapsed)

```{r auprc-simple-faceted, fig.width=14, fig.height=6}
# Helper to prepare facet data with optional dashed baselines for NA x values
prep_facet <- function(df, x_var, facet_label) {
  with_x <- df %>%
    dplyr::filter(!is.na(.data[[x_var]])) %>%
    dplyr::mutate(facet_label = facet_label, x = .data[[x_var]])
  
  x_range <- range(with_x$x, na.rm = TRUE)
  hlines <- df %>%
    dplyr::filter(is.na(.data[[x_var]])) %>%
    dplyr::mutate(
      facet_label = facet_label,
      x_start = x_range[1],
      x_end = x_range[2]
    )
  
  list(with_x = with_x, hlines = hlines)
}

auprc_inflate_simple <- test_susine::compute_auprc_from_confusion(
  confusion_base,
  group_vars = c("use_case_id", "inflate_match")
)

auprc_pstar_simple <- test_susine::compute_auprc_from_confusion(
  confusion_base,
  group_vars = c("use_case_id", "p_star")
)

facets <- list(
  prep_facet(auprc_inflate_simple, "inflate_match", "Inflation match factor"),
  prep_facet(auprc_pstar_simple, "p_star", "Expected signals per locus (p*)")
)

auprc_with_x_all <- purrr::map_dfr(facets, "with_x")
auprc_hlines_all <- purrr::map_dfr(facets, "hlines")

if (nrow(auprc_with_x_all) > 0) {
  p <- ggplot2::ggplot(
    auprc_with_x_all,
    ggplot2::aes(x = x, y = AUPRC, color = use_case_id, group = use_case_id)
  ) +
    ggplot2::geom_line(linewidth = 0.9) +
    ggplot2::geom_point(size = 2.5) +
    ggplot2::facet_wrap(~facet_label, ncol = 2, scales = "free") +
    ggplot2::scale_color_manual(values = use_case_palette, labels = use_case_labels) +
    ggplot2::labs(
      title = "AUPRC across alignment and signal burden",
      x = NULL,
      y = "AUPRC",
      color = "Use case"
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      legend.position = "bottom",
      legend.title = ggplot2::element_text(size = 12),
      legend.text = ggplot2::element_text(size = 12),
      strip.text.x = ggplot2::element_text(size = 13, face = "bold"),
      axis.title = ggplot2::element_text(size = 13),
      axis.text = ggplot2::element_text(size = 12),
      plot.title = ggplot2::element_text(size = 18, face = "bold")
    )
  
  if (nrow(auprc_hlines_all) > 0) {
    p <- p + ggplot2::geom_segment(
      data = auprc_hlines_all,
      ggplot2::aes(x = x_start, xend = x_end, y = AUPRC, yend = AUPRC, color = use_case_id),
      linewidth = 0.9,
      linetype = "dashed"
    )
  }
  
  save_or_show(p, "auprc_simple_faceted.png", width = 14, height = 6, subdir = "auprc_simple")
} else {
  message("No data for AUPRC simple facets")
}
```

---

# Section 4: AUPRC by annotation_r2 with p_star Facets

```{r auprc-annotation-pstar-faceted, fig.width=8, fig.height=12}
# Compute AUPRC separately for each p* group, then combine (like Power/FDR plot)
group_vars <- c("use_case_id", "annotation_r2", "sigma_0_2_scalar", "gamma_shrink")

# All p*
auprc_all <- test_susine::compute_auprc_from_confusion(
  confusion_base,
  group_vars = group_vars
) %>%
  dplyr::mutate(pstar_band = "All p*")

# Low p* (1-4)
confusion_low_ann <- confusion_base %>% dplyr::filter(p_star %in% c(1, 2, 3, 4))
auprc_low <- test_susine::compute_auprc_from_confusion(
 confusion_low_ann,
  group_vars = group_vars
) %>%
  dplyr::mutate(pstar_band = "p* 1-4")

# High p* (5, 10, 20)
confusion_high_ann <- confusion_base %>% dplyr::filter(p_star %in% c(5, 10, 20))
auprc_high <- test_susine::compute_auprc_from_confusion(
  confusion_high_ann,
  group_vars = group_vars
) %>%
  dplyr::mutate(pstar_band = "p* 5-20")

# Combine all three
auprc_ann_pstar <- dplyr::bind_rows(auprc_all, auprc_low, auprc_high)

if (nrow(auprc_ann_pstar) > 0) {
  pstar_levels <- c("All p*", "p* 1-4", "p* 5-20")
  
  # Separate a_i (with NAs) from others (with annotation_r2 values)
  ai_data <- auprc_ann_pstar %>%
    dplyr::filter(use_case_id == "a_i") %>%
    dplyr::mutate(
      pstar_band = factor(pstar_band, levels = pstar_levels),
      line_group = paste0(use_case_id, " - ", sigma_0_2_scalar)
    )
  
  other_data <- auprc_ann_pstar %>%
    dplyr::filter(use_case_id != "a_i") %>%
    dplyr::filter(!is.na(annotation_r2)) %>%
    dplyr::mutate(
      pstar_band = factor(pstar_band, levels = pstar_levels),
      line_group = dplyr::if_else(
        use_case_id == "b_i",
        paste0(use_case_id, " - ", gamma_shrink),
        paste0(use_case_id, " - ", sigma_0_2_scalar)
      )
    )
  
  # Create the plot
  p <- ggplot2::ggplot() +
    # Lines for non-a_i use cases
    ggplot2::geom_line(
      data = other_data,
      ggplot2::aes(x = annotation_r2, y = AUPRC, color = line_group, group = line_group),
      linewidth = 1.0,
      linetype = "solid"
    ) +
    ggplot2::geom_point(
      data = other_data,
      ggplot2::aes(x = annotation_r2, y = AUPRC, color = line_group),
      size = 3
    ) +
    # Dashed horizontal lines for a_i (NA values)
    ggplot2::geom_segment(
      data = ai_data,
      ggplot2::aes(x = -Inf, xend = Inf, y = AUPRC, yend = AUPRC, color = line_group),
      linewidth = 1.0,
      linetype = "dashed"
    ) +
    ggplot2::facet_wrap(~pstar_band, ncol = 1, scales = "free_y") +
    ggplot2::scale_color_manual(
      values = combined_palette,
      labels = combined_labels,
      name = "Method"
    ) +
    ggplot2::labs(
      title = "AUPRC by Annotation Quality, faceted by p* group",
      x = "Annotation Quality (causal R^2)",
      y = "AUPRC"
    ) +
    ggplot2::guides(
      color = ggplot2::guide_legend(
        title.position = "top",
        title.hjust = 0.5,
        ncol = 3,
        byrow = FALSE
      )
    ) +
    ggplot2::theme_minimal(base_size = 14) +
    ggplot2::theme(
      legend.position = "bottom",
      legend.title = ggplot2::element_text(size = 16, face = "bold"),
      legend.text = ggplot2::element_text(size = 14),
      legend.box.margin = ggplot2::margin(t = 10, b = 10, l = 0, r = 0),
      legend.key.width = ggplot2::unit(1.5, "lines"),
      strip.text.x = ggplot2::element_text(size = 16, face = "bold"),
      axis.title.x = ggplot2::element_text(size = 18, margin = ggplot2::margin(t = 10)),
      axis.title.y = ggplot2::element_text(size = 18),
      axis.text = ggplot2::element_text(size = 14),
      plot.title = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5),
      plot.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10)
    )
  
  save_or_show(p, "auprc_annotation_r2_by_pstar_band.png", width = 8, height = 12, subdir = "auprc_new")
} else {
  message("No data for annotation_r2 by p_star band plot")
}
```

## 4.1 AUPRC by annotation_r2 with p_star and annotation_scale Facets

```{r auprc-annotation-pstar-annscale-faceted, fig.width=16, fig.height=12}
# Compute AUPRC separately for each p* group and annotation_scale, then combine
group_vars_scale <- c("use_case_id", "annotation_r2", "sigma_0_2_scalar", "gamma_shrink", "annotation_scale")

# All p*
auprc_all_scale <- test_susine::compute_auprc_from_confusion(
  confusion_base,

  group_vars = group_vars_scale
) %>%
  dplyr::mutate(pstar_band = "All p*")

# Low p* (1-4)
auprc_low_scale <- test_susine::compute_auprc_from_confusion(
  confusion_low_ann,
  group_vars = group_vars_scale
) %>%
  dplyr::mutate(pstar_band = "p* 1-4")

# High p* (5, 10, 20)
auprc_high_scale <- test_susine::compute_auprc_from_confusion(
  confusion_high_ann,
  group_vars = group_vars_scale
) %>%
  dplyr::mutate(pstar_band = "p* 5-20")

# Combine all three
auprc_ann_pstar_scale <- dplyr::bind_rows(auprc_all_scale, auprc_low_scale, auprc_high_scale)

if (nrow(auprc_ann_pstar_scale) > 0) {
  pstar_levels <- c("All p*", "p* 1-4", "p* 5-20")

  # Get unique annotation_scale values for faceting
  ann_scale_vals <- sort(unique(auprc_ann_pstar_scale$annotation_scale[!is.na(auprc_ann_pstar_scale$annotation_scale)]))

  # Separate a_i (with NAs) from others (with annotation_r2 values)
  ai_data_scale <- auprc_ann_pstar_scale %>%
    dplyr::filter(use_case_id == "a_i") %>%
    dplyr::mutate(
      pstar_band = factor(pstar_band, levels = pstar_levels),
      line_group = paste0(use_case_id, " - ", sigma_0_2_scalar)
    )

  other_data_scale <- auprc_ann_pstar_scale %>%
    dplyr::filter(use_case_id != "a_i") %>%
    dplyr::filter(!is.na(annotation_r2)) %>%
    dplyr::mutate(
      pstar_band = factor(pstar_band, levels = pstar_levels),
      annotation_scale_label = paste0("Ann. Scale = ", annotation_scale),
      line_group = dplyr::if_else(
        use_case_id == "b_i",
        paste0(use_case_id, " - ", gamma_shrink),
        paste0(use_case_id, " - ", sigma_0_2_scalar)
      )
    )

  # For a_i, we need to replicate across annotation_scale facets
  if (nrow(ai_data_scale) > 0 && length(ann_scale_vals) > 0) {
    ai_data_scale <- ai_data_scale %>%
      dplyr::select(-annotation_scale) %>%
      tidyr::crossing(annotation_scale = ann_scale_vals) %>%
      dplyr::mutate(annotation_scale_label = paste0("Ann. Scale = ", annotation_scale))
  }

  # Create the plot with grid faceting
  p <- ggplot2::ggplot() +
    # Lines for non-a_i use cases
    ggplot2::geom_line(
      data = other_data_scale,
      ggplot2::aes(x = annotation_r2, y = AUPRC, color = line_group, group = line_group),
      linewidth = 1.0,
      linetype = "solid"
    ) +
    ggplot2::geom_point(
      data = other_data_scale,
      ggplot2::aes(x = annotation_r2, y = AUPRC, color = line_group),
      size = 3
    ) +
    # Dashed horizontal lines for a_i (NA values)
    ggplot2::geom_segment(
      data = ai_data_scale,
      ggplot2::aes(x = -Inf, xend = Inf, y = AUPRC, yend = AUPRC, color = line_group),
      linewidth = 1.0,
      linetype = "dashed"
    ) +
    ggplot2::facet_grid(pstar_band ~ annotation_scale_label, scales = "free_y") +
    ggplot2::scale_color_manual(
      values = combined_palette,
      labels = combined_labels,
      name = "Method"
    ) +
    ggplot2::labs(
      title = "AUPRC by Annotation Quality, faceted by p* group and Annotation Scale",
      x = "Annotation Quality (causal R^2)",
      y = "AUPRC"
    ) +
    ggplot2::guides(
      color = ggplot2::guide_legend(
        title.position = "top",
        title.hjust = 0.5,
        ncol = 3,
        byrow = FALSE
      )
    ) +
    ggplot2::theme_minimal(base_size = 14) +
    ggplot2::theme(
      legend.position = "bottom",
      legend.title = ggplot2::element_text(size = 16, face = "bold"),
      legend.text = ggplot2::element_text(size = 14),
      legend.box.margin = ggplot2::margin(t = 10, b = 10, l = 0, r = 0),
      legend.key.width = ggplot2::unit(1.5, "lines"),
      strip.text.x = ggplot2::element_text(size = 14, face = "bold"),
      strip.text.y = ggplot2::element_text(size = 14, face = "bold"),
      axis.title.x = ggplot2::element_text(size = 18, margin = ggplot2::margin(t = 10)),
      axis.title.y = ggplot2::element_text(size = 18),
      axis.text = ggplot2::element_text(size = 12),
      plot.title = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5),
      plot.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10)
    )

  save_or_show(p, "auprc_annotation_r2_by_pstar_band_and_annscale.png", width = 16, height = 12, subdir = "auprc_new")

  # New plot: annotation_scale on x-axis, faceted by p* band
  group_vars_scale_x <- c("use_case_id", "sigma_0_2_scalar", "gamma_shrink", "annotation_scale")

  auprc_all_scale_x <- test_susine::compute_auprc_from_confusion(
    confusion_base,
    group_vars = group_vars_scale_x
  ) %>%
    dplyr::mutate(pstar_band = "All p*")

  auprc_low_scale_x <- test_susine::compute_auprc_from_confusion(
    confusion_low_ann,
    group_vars = group_vars_scale_x
  ) %>%
    dplyr::mutate(pstar_band = "p* 1-4")

  auprc_high_scale_x <- test_susine::compute_auprc_from_confusion(
    confusion_high_ann,
    group_vars = group_vars_scale_x
  ) %>%
    dplyr::mutate(pstar_band = "p* 5-20")

  auprc_ann_pstar_scale_x <- dplyr::bind_rows(auprc_all_scale_x, auprc_low_scale_x, auprc_high_scale_x)

  if (nrow(auprc_ann_pstar_scale_x) > 0) {
    ai_data_scale_x <- auprc_ann_pstar_scale_x %>%
      dplyr::filter(use_case_id == "a_i") %>%
      dplyr::mutate(
        pstar_band = factor(pstar_band, levels = pstar_levels),
        line_group = paste0(use_case_id, " - ", sigma_0_2_scalar)
      )

    other_data_scale_x <- auprc_ann_pstar_scale_x %>%
      dplyr::filter(use_case_id != "a_i") %>%
      dplyr::filter(!is.na(annotation_scale)) %>%
      dplyr::mutate(
        pstar_band = factor(pstar_band, levels = pstar_levels),
        line_group = dplyr::if_else(
          use_case_id == "b_i",
          paste0(use_case_id, " - ", gamma_shrink),
          paste0(use_case_id, " - ", sigma_0_2_scalar)
        )
      )

    p_scale_x <- ggplot2::ggplot() +
      # Lines for non-a_i use cases
      ggplot2::geom_line(
        data = other_data_scale_x,
        ggplot2::aes(x = annotation_scale, y = AUPRC, color = line_group, group = line_group),
        linewidth = 1.0,
        linetype = "solid"
      ) +
      ggplot2::geom_point(
        data = other_data_scale_x,
        ggplot2::aes(x = annotation_scale, y = AUPRC, color = line_group),
        size = 3
      ) +
      # Dashed horizontal lines for a_i (NA values)
      ggplot2::geom_segment(
        data = ai_data_scale_x,
        ggplot2::aes(x = -Inf, xend = Inf, y = AUPRC, yend = AUPRC, color = line_group),
        linewidth = 1.0,
        linetype = "dashed"
      ) +
      ggplot2::facet_wrap(~pstar_band, ncol = 1, scales = "free_y") +
      ggplot2::scale_color_manual(
        values = combined_palette,
        labels = combined_labels,
        name = "Method"
      ) +
      ggplot2::labs(
        title = "AUPRC by Annotation Scale, faceted by p* group",
        x = "Annotation Scale",
        y = "AUPRC"
      ) +
      ggplot2::guides(
        color = ggplot2::guide_legend(
          title.position = "top",
          title.hjust = 0.5,
          ncol = 3,
          byrow = FALSE
        )
      ) +
      ggplot2::theme_minimal(base_size = 14) +
      ggplot2::theme(
        legend.position = "bottom",
        legend.title = ggplot2::element_text(size = 16, face = "bold"),
        legend.text = ggplot2::element_text(size = 14),
        legend.box.margin = ggplot2::margin(t = 10, b = 10, l = 0, r = 0),
        legend.key.width = ggplot2::unit(1.5, "lines"),
        strip.text.x = ggplot2::element_text(size = 14, face = "bold"),
        axis.title.x = ggplot2::element_text(size = 18, margin = ggplot2::margin(t = 10)),
        axis.title.y = ggplot2::element_text(size = 18),
        axis.text = ggplot2::element_text(size = 12),
        plot.title = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5),
        plot.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10)
      )

    save_or_show(p_scale_x, "auprc_annotation_scale_by_pstar_band.png", width = 8, height = 12, subdir = "auprc_new")
  } else {
    message("No data for annotation_scale by p_star band plot")
  }

  # Same plot, but color by annotation_scale (red/orange palette) instead of faceting by it
  ann_scale_labels <- paste0("Ann. Scale = ", ann_scale_vals)
  ann_scale_palette <- grDevices::colorRampPalette(
    c("#1a9850", "#d73027")
  )(length(ann_scale_vals))
  names(ann_scale_palette) <- ann_scale_labels
  sigma_0_2_vals <- sort(unique(auprc_ann_pstar_scale$sigma_0_2_scalar[!is.na(auprc_ann_pstar_scale$sigma_0_2_scalar)]))
  sigma_0_2_labels <- paste0("sigma_0_2 = ", sigma_0_2_vals)

  other_data_scale_color <- other_data_scale %>%
    dplyr::filter(!is.na(sigma_0_2_scalar)) %>%
    dplyr::mutate(
      annotation_scale_label = factor(annotation_scale_label, levels = ann_scale_labels),
      sigma_0_2_label = factor(paste0("sigma_0_2 = ", sigma_0_2_scalar), levels = sigma_0_2_labels)
    )

  ai_data_scale_color <- ai_data_scale %>%
    dplyr::filter(!is.na(sigma_0_2_scalar)) %>%
    dplyr::mutate(
      annotation_scale_label = factor(annotation_scale_label, levels = ann_scale_labels),
      sigma_0_2_label = factor(paste0("sigma_0_2 = ", sigma_0_2_scalar), levels = sigma_0_2_labels)
    )

  p_color <- ggplot2::ggplot() +
    # Lines for non-a_i use cases
    ggplot2::geom_line(
      data = other_data_scale_color,
      ggplot2::aes(
        x = annotation_r2,
        y = AUPRC,
        color = annotation_scale_label,
        group = interaction(line_group, annotation_scale_label)
      ),
      linewidth = 1.0,
      linetype = "solid"
    ) +
    ggplot2::geom_point(
      data = other_data_scale_color,
      ggplot2::aes(x = annotation_r2, y = AUPRC, color = annotation_scale_label),
      size = 3
    ) +
    # Dashed horizontal lines for a_i (NA values)
    ggplot2::geom_segment(
      data = ai_data_scale_color,
      ggplot2::aes(x = -Inf, xend = Inf, y = AUPRC, yend = AUPRC),
      color = "gray60",
      linewidth = 1.0,
      linetype = "dashed"
    ) +
    ggplot2::facet_grid(pstar_band ~ sigma_0_2_label, scales = "free_y") +
    ggplot2::scale_color_manual(
      values = ann_scale_palette,
      name = "Annotation Scale"
    ) +
    ggplot2::labs(
      title = "AUPRC by Annotation Quality, colored by Annotation Scale and faceted by p* group",
      x = "Annotation Quality (causal R^2)",
      y = "AUPRC"
    ) +
    ggplot2::guides(
      color = ggplot2::guide_legend(
        title.position = "top",
        title.hjust = 0.5,
        ncol = 3,
        byrow = FALSE
      )
    ) +
    ggplot2::theme_minimal(base_size = 14) +
    ggplot2::theme(
      legend.position = "bottom",
      legend.title = ggplot2::element_text(size = 16, face = "bold"),
      legend.text = ggplot2::element_text(size = 14),
      legend.box.margin = ggplot2::margin(t = 10, b = 10, l = 0, r = 0),
      legend.key.width = ggplot2::unit(1.5, "lines"),
      strip.text.y = ggplot2::element_text(size = 14, face = "bold"),
      axis.title.x = ggplot2::element_text(size = 18, margin = ggplot2::margin(t = 10)),
      axis.title.y = ggplot2::element_text(size = 18),
      axis.text = ggplot2::element_text(size = 12),
      plot.title = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5),
      plot.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10)
    )

  save_or_show(p_color, "auprc_annotation_r2_by_pstar_band_and_annscale_color.png", width = 8, height = 12, subdir = "auprc_new")
} else {
  message("No data for annotation_r2 by p_star band and annotation_scale plot")
}
```

## 4.2 AUPRC by annotation_r2 with inflate_match and annotation_scale Facets

```{r auprc-annotation-inflate-annscale-faceted, fig.width=16, fig.height=12}
# Compute AUPRC for each inflate_match level with annotation_scale, split by p* bands
group_vars_inflate <- c("use_case_id", "annotation_r2", "sigma_0_2_scalar", "gamma_shrink", "annotation_scale", "inflate_match")

pstar_bands <- list(
  list(label = "All p*", values = NULL, filename = "auprc_annotation_r2_by_inflate_match_and_annscale.png"),
  list(label = "p* 1-4", values = c(1, 2, 3, 4), filename = "auprc_annotation_r2_by_inflate_match_and_annscale_pstar_1_4.png"),
  list(label = "p* 5-20", values = c(5, 10, 20), filename = "auprc_annotation_r2_by_inflate_match_and_annscale_pstar_5_20.png")
)

for (band in pstar_bands) {
  confusion_band <- confusion_base
  if (!is.null(band$values)) {
    confusion_band <- confusion_band %>% dplyr::filter(p_star %in% band$values)
  }

  auprc_inflate_scale <- test_susine::compute_auprc_from_confusion(
    confusion_band,
    group_vars = group_vars_inflate
  )

  if (nrow(auprc_inflate_scale) > 0) {
    # Get unique annotation_scale and inflate_match values for faceting
    ann_scale_vals <- sort(unique(auprc_inflate_scale$annotation_scale[!is.na(auprc_inflate_scale$annotation_scale)]))
    inflate_vals <- sort(unique(auprc_inflate_scale$inflate_match[!is.na(auprc_inflate_scale$inflate_match)]))

    # Separate a_i (with NAs) from others (with annotation_r2 values)
    ai_data_inflate <- auprc_inflate_scale %>%
      dplyr::filter(use_case_id == "a_i") %>%
      dplyr::mutate(
        line_group = paste0(use_case_id, " - ", sigma_0_2_scalar)
      )

    other_data_inflate <- auprc_inflate_scale %>%
      dplyr::filter(use_case_id != "a_i") %>%
      dplyr::filter(!is.na(annotation_r2), !is.na(inflate_match)) %>%
      dplyr::mutate(
        inflate_match_label = paste0("Inflate Match = ", inflate_match),
        annotation_scale_label = paste0("Ann. Scale = ", annotation_scale),
        line_group = dplyr::if_else(
          use_case_id == "b_i",
          paste0(use_case_id, " - ", gamma_shrink),
          paste0(use_case_id, " - ", sigma_0_2_scalar)
        )
      )

    # For a_i, we need to replicate across annotation_scale and inflate_match facets
    if (nrow(ai_data_inflate) > 0 && length(ann_scale_vals) > 0 && length(inflate_vals) > 0) {
      ai_data_inflate <- ai_data_inflate %>%
        dplyr::select(-annotation_scale, -inflate_match) %>%
        tidyr::crossing(annotation_scale = ann_scale_vals, inflate_match = inflate_vals) %>%
        dplyr::mutate(
          inflate_match_label = paste0("Inflate Match = ", inflate_match),
          annotation_scale_label = paste0("Ann. Scale = ", annotation_scale)
        )
    }

    plot_title <- if (band$label == "All p*") {
      "AUPRC by Annotation Quality, faceted by Inflate Match and Annotation Scale"
    } else {
      paste0("AUPRC by Annotation Quality, faceted by Inflate Match and Annotation Scale (", band$label, ")")
    }

    # Create the plot with grid faceting
    p <- ggplot2::ggplot() +
      # Lines for non-a_i use cases
      ggplot2::geom_line(
        data = other_data_inflate,
        ggplot2::aes(x = annotation_r2, y = AUPRC, color = line_group, group = line_group),
        linewidth = 1.0,
        linetype = "solid"
      ) +
      ggplot2::geom_point(
        data = other_data_inflate,
        ggplot2::aes(x = annotation_r2, y = AUPRC, color = line_group),
        size = 3
      ) +
      # Dashed horizontal lines for a_i (NA values)
      ggplot2::geom_segment(
        data = ai_data_inflate,
        ggplot2::aes(x = -Inf, xend = Inf, y = AUPRC, yend = AUPRC, color = line_group),
        linewidth = 1.0,
        linetype = "dashed"
      ) +
      ggplot2::facet_grid(inflate_match_label ~ annotation_scale_label, scales = "free_y") +
      ggplot2::scale_color_manual(
        values = combined_palette,
        labels = combined_labels,
        name = "Method"
      ) +
      ggplot2::labs(
        title = plot_title,
        x = "Annotation Quality (causal R^2)",
        y = "AUPRC"
      ) +
      ggplot2::guides(
        color = ggplot2::guide_legend(
          title.position = "top",
          title.hjust = 0.5,
          ncol = 3,
          byrow = FALSE
        )
      ) +
      ggplot2::theme_minimal(base_size = 14) +
      ggplot2::theme(
        legend.position = "bottom",
        legend.title = ggplot2::element_text(size = 16, face = "bold"),
        legend.text = ggplot2::element_text(size = 14),
        legend.box.margin = ggplot2::margin(t = 10, b = 10, l = 0, r = 0),
        legend.key.width = ggplot2::unit(1.5, "lines"),
        strip.text.x = ggplot2::element_text(size = 14, face = "bold"),
        strip.text.y = ggplot2::element_text(size = 14, face = "bold"),
        axis.title.x = ggplot2::element_text(size = 18, margin = ggplot2::margin(t = 10)),
        axis.title.y = ggplot2::element_text(size = 18),
        axis.text = ggplot2::element_text(size = 12),
        plot.title = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5),
        plot.margin = ggplot2::margin(t = 10, b = 10, l = 10, r = 10)
      )

    save_or_show(p, band$filename, width = 16, height = 12, subdir = "auprc_new")
  } else {
    message("No data for annotation_r2 by inflate_match and annotation_scale plot for ", band$label)
  }
}
```









