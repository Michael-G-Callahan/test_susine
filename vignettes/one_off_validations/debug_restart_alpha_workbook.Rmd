---
title: "Debug Restart Alpha Generation (One-Off)"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
editor_options:
  markdown:
    wrap: 72
---

Summary: Minimal debugger walk-through to inspect restart `alpha` generation and
confirm how `init_alpha` is passed into `susine::susine()` for a single run.
Includes quick alpha sampling diagnostics and a small warm-start sweep to
inspect multimodal metrics.

```{r setup, message=FALSE}
here::i_am("vignettes/one_off_validations/debug_restart_alpha_workbook.Rmd")
library(here)
here()

library(devtools)
devtools::load_all(".")
susine_path <- here("..", "susine")
if (file.exists(file.path(susine_path, "DESCRIPTION"))) {
  devtools::load_all(susine_path)
} else {
  warning("susine package not found at: ", susine_path)
}

library(dplyr)
library(readr)
```

# 1. Define a Mini Config (Standalone)

This workbook is self-contained: set the inputs below and it will build a
minimal run table and data bundle for debugging.

```{r mini-config}
job_inputs <- list(
  use_case_id = "a_i_restart",
  L = 10,
  y_noise = 0.6,
  p_star = 10,
  phenotype_seed = 390,
  sigma_0_2_scalar = "0.2",
  annotation_r2 = NA_real_,
  inflate_match = NA_real_,
  gamma_shrink = NA_real_,
  annotation_scale = NA_real_,
  restart_id = 1,
  alpha_concentration = 0.001,
  n_inits = 5,
  seed = 1
)
```

```{r build-mini}
job_config <- test_susine::make_job_config(
  job_name = "debug_restart_alpha",
  use_case_ids = job_inputs$use_case_id,
  L_grid = job_inputs$L,
  y_noise_grid = job_inputs$y_noise,
  prior_quality = test_susine::prior_quality_grid(
    annotation_r2_levels = job_inputs$annotation_r2,
    inflate_match_levels = job_inputs$inflate_match,
    gamma_shrink_levels = job_inputs$gamma_shrink
  ),
  p_star_grid = job_inputs$p_star,
  seeds = job_inputs$seed,
  data_scenarios = "scenario_1",
  repo_root = here(),
  sampled_scenario_summary = here("data", "sampled_simulated_genotypes", "scenario_sampling_summary.csv"),
  task_unit = "dataset",
  bundles_per_task = 1,
  sigma_0_2_scalars = job_inputs$sigma_0_2_scalar,
  annotation_scales = if (is.na(job_inputs$annotation_scale)) NULL else job_inputs$annotation_scale,
  restart_settings = list(
    n_inits = job_inputs$n_inits,
    alpha_concentration = job_inputs$alpha_concentration
  )
)

run_table <- job_config$tables$runs
restart_row <- run_table %>% filter(use_case_id == job_inputs$use_case_id) %>% slice(1)
restart_row
```

# 2. Build Data Bundle (Required for Alpha Sampling)

```{r build-data-bundle}
data_bundle <- test_susine:::generate_data_for_bundle(
  job_config$tables$dataset_bundles %>% filter(dataset_bundle_id == restart_row$dataset_bundle_id),
  job_config
)
```

# 3. Debug the Alpha Generation Path

We break inside `run_use_case()` and inspect:
- `restart_seed`
- sampled `init_alpha`
- the arguments passed into `susine::susine()`

```{r debug-run-use-case, eval=FALSE}
options(error = quote(browser()))
debugonce(test_susine:::run_use_case)

# Run a single use-case call (will drop into debugger)
use_case <- test_susine:::lookup_use_case(job_config, restart_row$use_case_id)
test_susine:::run_use_case(use_case, restart_row, data_bundle, job_config)
```

## When the debugger stops inside `run_use_case()`

Run these commands:

```r
restart_seed
restart_id
alpha_conc
init_alpha[1:2, 1:10]
range(init_alpha)
```

To inspect the call into susine, look at `base_args`:

```r
names(base_args)
str(base_args$init_alpha)
```

Then step through the call:

```r
step
```

# 3. Step Into susine::susine()

To debug inside the susine package, insert a breakpoint:

```{r debug-susine, eval=FALSE}
debugonce(susine::susine)

# Re-run the same call (will stop inside susine)
test_susine:::run_use_case(use_case, restart_row, data_bundle, job_config)
```

Inside `susine::susine()`, inspect:

```r
init_alpha
```

If `init_alpha` is not present or is being overwritten, note where that happens
in the susine code path.

# 4. Compare Multiple Restarts (Optional)

```{r compare-restarts}
restart_rows <- run_table %>%
  filter(use_case_id == "a_i_restart",
         dataset_bundle_id == restart_row$dataset_bundle_id,
         group_key == restart_row$group_key) %>%
  arrange(restart_id) %>%
  slice(1:3)

restart_rows
```

Re-run Section 2 with each `restart_row` above and compare `init_alpha`.

# 6. Alpha Sampling Diagnostics (Histogram)

Use this section to experiment with `alpha_concentration` and visualize the
distribution of `init_alpha` entries across samples.

```{r alpha-sampling}
alpha_concentration <- job_inputs$alpha_concentration
n_samples <- 50

L <- as.integer(restart_row$L)
p <- ncol(data_bundle$X)
alpha_vec <- rep(alpha_concentration, p)

alpha_samples <- lapply(seq_len(n_samples), function(i) {
  test_susine:::dirichlet_matrix(L, alpha_vec)
})
alpha_values <- unlist(lapply(alpha_samples, as.numeric))

hist(
  alpha_values,
  breaks = 50,
  main = sprintf("Dirichlet alpha values (conc = %s)", alpha_concentration),
  xlab = "alpha entries"
)

head(sort(alpha_values, decreasing = TRUE), L*n_samples)

sum(alpha_values)

```

# 7. Warm-Start Sweep + Multimodal Metrics

Generate a small set of restart fits (same data) and compute quick
multimodal diagnostics.

```{r warm-start-sweep}
n_inits <- job_inputs$n_inits
alpha_concentration <- job_inputs$alpha_concentration

use_case <- test_susine:::lookup_use_case(job_config, job_inputs$use_case_id)
fits <- lapply(seq_len(n_inits), function(i) {
  rr <- restart_row
  rr$restart_id <- i
  rr$restart_seed <- i
  job_config$job$compute$restart$alpha_concentration <- alpha_concentration
  test_susine:::run_use_case(use_case, rr, data_bundle, job_config)$fits[[1]]
})

pips <- lapply(fits, function(fit) fit$model_fit$PIPs)
mm <- test_susine:::compute_multimodal_metrics(
  pips,
  jsd_threshold = job_config$job$metrics$jsd_threshold %||% 0.171661,
  top_k = 10L
)

mm
```

# 5. Cleanup

```{r cleanup}
options(error = NULL)
undebug(test_susine:::run_use_case)
undebug(susine::susine)
```
